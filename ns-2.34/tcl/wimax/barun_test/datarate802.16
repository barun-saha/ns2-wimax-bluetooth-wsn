#!/bin/bash

# Bash file to run datarate simulations for different modulation and cyclic prefix
# @author rouil

RUN_PARALLEL=0              #indicates if we can run in parallel processes (will launch 7 processes)

function check_files {
   echo "Checking for necessary files in the current directory:"
    if [ -e PED_A ]; then
	echo "PED_A file found"
    else
	echo "PED_A not found. Creating symbolink link to ../../PED_A"
	ln -s ../../../PED_A
    fi
    
    if [ -e BetaTable.txt ]; then
	echo "BetaTable.txt found"
    else
	echo "BetaTable.txt not found. Creating symbolink link to ../../BetaTable.txt"
	ln -s ../../../BetaTable.txt
    fi
    
    if [ -e BLER_LookupTable.txt ]; then
	echo "BLER_LookupTable.txt found"
    else
	echo "BLER_LookupTable.txt not found. Creating symbolink link to ../../BLER_LookupTable.txt"
	ln -s ../../../BLER_LookupTable.txt
    fi
    echo "Check complete...run simulations"
}

function test_modulation {
    modulation=$1
    cp=0.25    
    for modulation in "1" ; do #"2" "3" "4" "5"; do
        for x_dist in "500" "1000" "2500" "3000"; do
            for cp in "0" "0.03125" "0.0625" "0.125" "0.25"; do
	            echo "Running for modulation $modulation, xdist=$x_dist and CP=$cp"
	            ns datarate.tcl $modulation $x_dist $cp &> /dev/null

	            TRACE_FILE="wimax_mod_${modulation}_${x_dist}.tr"

	            # Receive events by sink node in wired mode
	            DATARATE=`grep ^r ${TRACE_FILE} | grep "1 0 cbr" | awk 'BEGIN{first=-1; last=-1; i=0;} {if (first==-1) {first=$2}; last=$2; i+=$6;} END {print (8*i/(last-first+0.000001))/1024}'`
	            echo " datarate = " $DATARATE
	            echo $modulation $x_dist $DATARATE >>res_datarate/result$modulation_$x_dist.dat
	            echo $modulation $x_dist $DATARATE >>res_datarate/result$modulation_$x_dist.dat
	            #rm "$TRACE_FILE"
	        done
        done
    done
    if [ "$1" != "" ]; then
	    break
    fi
}

#Main code
if [ "$1" == "clean" ]; then
	rm -fr res_datarate
else
    check_files
    mkdir res_datarate

    for mod in "1" "2" "3" "4" "5" "6" "7"; do
	if [ "$RUN_PARALLEL" = "1" ]; then
	    test_modulation $mod &
	else
	    test_modulation $mod 
	fi
    done
    wait
 
    #gnuplot plot-datarate
fi

